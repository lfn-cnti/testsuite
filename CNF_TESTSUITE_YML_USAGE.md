# Test Suite Configuration Usage: cnf-testsuite.yml
### What is the cnf-testsuite.yml and why is it required?:

The cnf-testsuite.yml is used by `cnf_install` in order to install the CNF to be tested onto an existing K8s cluster. 


The information in the cnf-testsuite.yml is also used for additional configuration of some tests e.g. `white_list_container_names` is used for exculding containers from the [privileged_containers](https://github.com/lfn-cnti/testsuite/blob/main/src/tasks/workload/security.cr#L138) container test.


### Table of Contents

- [Overview](#Overview-of-all-cnf-testsuite.yml)
- [Generator Quick Start](#Generator-Quick-Start)
- [Keys and Values](#Keys-and-Values)


### Overview of all cnf-testsuite.yml

The following is a basic working example cnf-testsuite.yml file that can be found in the CNTi Test Suite respository: [/spec/fixtures/cnf-testsuite-v2-example.yml](https://github.com/lfn-cnti/testsuite/blob/main/spec/fixtures/cnf-testsuite-v2-example.yml)

```yaml=
---
config_version: "v2"
common: 
  container_names:
    - name: coredns
      rolling_update_test_tag: "1.8.0"
      rolling_downgrade_test_tag: 1.6.7
      rolling_version_change_test_tag: 1.8.0
      rollback_from_tag: 1.8.0

deployments:
  helm_charts:
    - name: coredns
      helm_repo_name: stable
      helm_repo_url: https://cncf.gitlab.io/stable
      helm_chart_name: coredns
#  helm_dirs:
#    - name: envoy
#      helm_directory: ../example-cnfs/envoy/envoy
#  manifests:
#    - name: nginx
#      manifest_directory: manifests
```

### Generator Quick Start

cnf-testsuite.yml can be dynamically generated by running `./cnf-testsuite generate_config`.
The process is interactive an should be friendly to new users.
Prereqs: You must have kubernetes cluster, curl, and helm 3.1.1 or greater on your system already.

### Updating config from older versions

New releases may change the format of cnf-testsuite.yml. To update your older configs automatically to the latest version, use the `update_config` task.

```
./cnf-testsuite update_config input_config=OLD_CONFIG_PATH output_config=NEW_CONFIG_PATH
```

### Keys and Values

#### Environment variables (Jinja)

You can reference environment variables with Crinja syntax: {{ ENV.VAR_NAME }}. Rendering is applied only if the config contains {{ ENV. or {% … %}. Avoid mixing Helm/Go templates (e.g., {{ .Release.Namespace }}) with Crinja; quote them to keep them literal.

```yaml
config_version: v2
deployments:
  helm_charts:
    - name: private-chart
      helm_repo_name: corp
      helm_repo_url: "https://charts.example.com"
      helm_chart_name: awesome
      auth:
        username: "{{ ENV.REPO_USER }}"
        password: "{{ ENV.REPO_PASS }}"
```

#### Config version

Current config version is `"v2"`
Missing config version is presumed to be config version `"v1"`, which is not supported, but should be transformed to new version if written correctly.

#### Common Parameters

Common parameters are required for proper functioning of some tests. If these parameters are not set up, corresponding tests will be failed/skipped or would not function properly (in example - white_list_container_names).
`common: ...`

##### container_names
Array of container parameters for rolling version change tests, example:
  name: coredns
  rolling_update_test_tag: 1.8.0
  rolling_downgrade_test_tag: 1.6.7
  rolling_version_change_test_tag: 1.8.0
  rollback_from_tag: 1.8.0


##### white_list_container_names

The values of this key are the names of the 'containers' defined in the Kubernetes pod spec of pods that are allowed to be running in privileged mode. (Optional)
This value is used to allow 'particular' pods to run in privileged mode on the K8s cluster where the CNF is installed.
The reason this is needed is because the Test Suite will check, 'all' pods in the cluster, to see if they're running in privileged mode.
This is done because it's a common cloud-native practice to delegate 'privileged' networking tasks to only a single app e.g. Multus, NSM vs making the CNF privileged itself. As a consequence the whitelist can only be used to exempt 'privileged' infrastructure services running as pods e.g. NSM, Multus and cannot be used to exempt the CNF under test.

Example setting:

`white_list_container_names: [coredns]`

##### hardcoded_ip_exceptions 

The values of this optional key are the IP addresses that are allowed to appear as hardcoded values in the configuration of the CNF.
This value is used to allow particular hardcoded IPs to be exempted from the `hardcoded_ip_adresses_in_k8s_runtime_configuration` test when the CNF is being validated.
The reason this is needed is because the CNF Testsuite checks all configuration files and manifests used by the CNF for the presence of hardcoded IP addresses.
While hardcoding IPs is generally discouraged in cloud-native environments, there may be cases where certain addresses are justified and cannot be avoided.
This exception list can be used to explicitly allow such IPs and prevent them from being reported as violations.

````yaml
config_version: v2
common:
  hardcoded_ip_exceptions:
    - ip: 8.8.8.8
    - ip: 4.4.4.4
````

##### `docker_insecure_registries`

The docker client expects the image registries to be using an HTTPS API endpoint. This option is used to configure insecure registries that the docker client should be allowed to access.

This parameter is responsible for configuring Docker to use HTTP when accessing the registry API.

For an image registry service named `foobar`, running in `default` namespace, on port `5000`, the following would be the expected configuration.

```yaml
docker_insecure_registries: ["foobar.default.svc.cluster.local:5000"]
```

##### `image_registry_fqdns`

When using a private registry hosted on the cluster, the image references in the CNF's helm chart may refer to the registry host with the Kubernetes service name alone. The CNF Testsuite runs a docker daemon in a separate `cnf-testsuite` namespace on the Kubernetes cluster. So it is required for the testsuite to be aware of the FQDN of the service, along with the port.

Use this option to configure FQDNs of image registries for the testsuite to access.

If the CNF's helm charts use the image url `foobar:5000/hello:latest`, then please use the configuration in below in `cnf-testsuite.yml` to provide the FQDN mapping for the image registry.

```yaml
image_registry_fqdns:
    "foobar:5000": "foobar.default.svc.cluster.local:5000"
```

##### five_g_parameters

Described below: [link](#5G-parameters)


##### tls_profiles

Define reusable TLS bundles (CA/cert/key) that deployments can reference. Useful for private Helm repos and OCI registries.

```yaml
config_version: v2
common:
  tls_profiles:
    corp_ca:
      ca_file:   /path/to/ca.crt
      cert_file: /path/to/client.crt
      key_file:  /path/to/client.key
deployments:
  helm_charts:
    - name: web-frontend
      tls_profile: corp_ca
      ...
```

##### auth_defaults

Optional default credentials for private repositories and registries. Keys are hosts; values are credentials. Per-chart auth can override these.

```yaml
config_version: v2
common:
  auth_defaults:
    oci_registries:
      "registry.example.com":
        token: "{{ ENV.OCI_TOKEN }}"      # or username/password
    helm_repos:
      "charts.example.com":
        username: "my_username554"
        password: "{{ ENV.REPO_PASS }}"
helm_charts:
  # Classic Helm repo – uses auth_defaults.
  - name: web-frontend
    helm_repo_name: corp
    helm_repo_url: "https://charts.example.com"
    helm_chart_name: web-frontend
    ...
  - name: web-backend
    registry_url: "oci://registry.example.com/team/nginx"
    chart_version: 1.0.2
    auth:
      token: "{{ ENV.TOKEN_OVERRIDE }}

```

**Note:** If you pre-login (e.g., helm registry login … or helm repo add … with credentials), you don’t need to specify auth in the config.

#### Deployments

Deployments are defined as three arrays, each for different installation method. Each array element represents one deployment, and they are meant to represent a single CNF together.
At least one deployment should exist in CNF config for it to be a proper config.
All info for deployments is used in cnf_install and cnf_uninstall tasks.

```yaml
---
config_version: "v2"
deployments:
  helm_charts:
  ...
  helm_dirs:
  ...
  manifests:
  ...
```

##### Deployment priority

To ensure deployments are executed in a specific order, you can use the `priority` parameter. Deployments are processed in ascending order of their `priority` values, starting with the lowest. During uninstallation, the order is reversed, processing from the highest `priority` value to the lowest. If the `priority` parameter is not specified, it defaults to 0.

```yaml
---
config_version: "v2"
deployments:
  helm_dirs: 
    - name: envoy # deploys second
      helm_directory: ../example-cnfs/envoy/envoy
      priority: 1
  manifests: 
    - name: nginx # implicit priority = 0, deploys first
      manifest_directory: manifests
```

##### helm_charts

Deployment from either a classic Helm repository or an OCI registry.

###### Classic Helm repositories

```yaml
---
config_version: "v2"
deployments:
  helm_charts:
    - name: coredns                                 # Name of the deployment
      helm_repo_name: stable                        # Name of the repository for the helm chart
      helm_repo_url: https://cncf.gitlab.io/stable  # Required if helm_repo_url is set
      helm_chart_name: coredns                      # Name of the helm chart in format repo_name/chart_name

      # Optional keys
      chart_version: 10.2.1
      helm_values: --set myvalue=42                 # Additional values that would be used for helm installation
      namespace: cnf-default                        # Defaults to cnf-default
      skip_tls_verify: false                        # Disable TLS verification
      pass_credentials: false                       # Pass creds on redirects
      auth:                                         # Optional per-chart override
        username: "{{ ENV.REPO_USER }}"
        password: "{{ ENV.REPO_PASS }}"
```

**Notes:**`
- If the repo was already added locally, you may omit `helm_repo_url`.
- `tls_profile` attaches `ca_file`/`cert_file`/`key_file` to Helm operations against that repo.
- `skip_tls_verify` disables certificate verification (use with care).
- `pass_credentials` forwards auth across redirects.
- Auth may be a bearer token or username/password. If you already added the repo with `helm repo add`, you do not need to set auth.

###### OCI registries

```yaml
---
config_version: "v2"
deployments:
  helm_charts:
    - name: nginx-oci                                        # Name of the deployment
      registry_url: "oci://registry.example.com/team/nginx"  # must start with oci://
      chart_version: "15.10.0"                               # required for OCI

      # Optional keys
      helm_values: --set myvalue=42                          # Additional values that would be used for helm installation
      namespace: cnf-default                                 # Defaults to cnf-default
      skip_tls_verify: false                                 # Disable TLS verification
      plain_http: false                                      # optional: use HTTP instead of HTTPS
      auth:                                                  # optional per-chart override
        token: "{{ ENV.OCI_TOKEN }}"
```

**Notes:**
- For OCI, `chart_version` is required.
- `registry_url` determines the chart name automatically (last path segment).
- Set plain_http: true only if your registry is HTTP.
- Auth may be a bearer token or username/password. If you already logged in with `helm registry login`, you do not need to set auth.

##### helm_dirs

Deployment, defined by directory with Chart.yaml file and all templates for resources.
Explanations with example:
```yaml
---
config_version: "v2"
deployments:
  helm_dirs:
    - name: envoy                     # Name of the deployment
      helm_directory: chart           # Path to the directory with Chart.yaml, relative to CNF configuration file
      helm_values: --set myvalue=42   # Additional values that would be used for helm installation
      namespace: cnf-default          # Namespace to which deployment would be installed (cnf-default is default)
```

##### manifests

Deployment, defined by directory with manifest files, that are meant to be directly installed by Kubernetes.
Explanations with example:
```yaml
---
config_version: "v2"
deployments:
  manifests:
    - name: nginx  # Name of the deployment
      manifest_directory: manifests  # Path to the directory with deployment manifests, relative to CNF configuration file
```

### 5G Parameters

These parameters are used for RAN, Open5gs and UERANSIM tests

#### `ric_label`

The ran tests expect a ric to be configured under the ric_label.  The entry must be the k8s label which is most likely a full key/value identification.

For a ric named `flexrric`, under the label key `app.kubernetes.io/name` the following would be the expected configuration.

```yaml
ric_label:  app.kubernetes.io/name=flexric
```

#### mmc

Mobile Country Code. This identifies the country of the mobile subscriber. In this case, '999' is a test code.

```yaml
dmmc: '999
```
#### mnc

Mobile Network Code. This identifies the mobile network within the country specified by the MCC. '70' is a test code.
```yaml
mnc: '70'
```

#### sst

Single-NEC Single Radio Voice Call Continuity. This value indicates the type of services a Slice/Session should support.

```yaml
sst: 1
```

#### sd

Slice Differentiator. This is used to differentiate between different slices within the same SST.

```yaml
sd: '0x111111'
```

#### tac

Tracking Area Code. This is used for paging procedures and to manage mobility between eNBs in LTE.

```yaml
tac: '0001'
```
#### protectionScheme

The type of security protocol being used.

```yaml
protectionScheme: 1
```
#### publicKey

This is the public key used in asymmetric encryption.

```yaml
publicKey: 0ac95ceeb93308df01be82ff9994d8330e38804ece1700ee4b972d8028796275
```

#### publicKeyId

Identifier for the public key.

```yaml
publicKeyId: 1:
```

#### routingIndicator

This is used to route messages in the network.

```yaml
routingIndicator: '0000'
```

#### enabled

Indicates whether the network is currently enabled or not.

```yaml
enabled: true
```

#### count

Used in UERANSIM to specify the number of entities (like User Equipment or UEs) to be simulated.

```yaml
count: 1
```

#### initialMSISDN

This MSISDN is a unique number that identifies a subscription in a GSM or a UMTS mobile network.

```yaml
initialMSISDN: '0000000001'
```

#### key

Cryptographic key used in the network.

```yaml
key: 465B5CE8B199B49FAA5F0A2EE238A6BC:
```

#### op

The operator variant algorithm configuration field. Used in conjunction with the key for security purposes.

```yaml
op: E8ED289DEBA952E4283B54E88E6183CA
```

#### opType

Indicates that the operator variant algorithm is in use.

```yaml
opType: OPC
```

#### type

The type of IP addresses being used in the network.

```yaml
type: 'IPv4'
```

#### apn

Access Point Name. This is the name of a gateway between a GPRS, 3G or 4G mobile network and another computer network, frequently the public internet.

```yaml
apn: 'internet'
```

#### emergency:

Indicates whether this is an emergency APN.

```yaml
emergency: false
```

